## Account Service

### 1. Overview
The account service manages **customer bank accounts**, **transactions**, and **Smart Goals (savings goals with auto-sweep)**.  
It exposes REST APIs, persists data in PostgreSQL via Flyway migrations, and publishes Kafka events using a shared JSON schema.  
All Kafka activity (publish + consume) is tracked in an `event_audit_logs` table with Micrometer metrics.

### 2. Running Locally
- **Prerequisites**
  - Java 21
  - Maven
  - Local Postgres (database `account_service`, user `account_svc`)
  - Local Kafka on `localhost:9092`

- **Start infra (if using the provided docker compose):**

   ```bash
   cd /Users/tariyalji/gitbot/banking-platform/infrastructure
   docker compose up -d
   ```

- **Run account-service:**

   ```bash
   cd /Users/tariyalji/gitbot/banking-platform/services/account-service
   mvn spring-boot:run
   ```

- **Endpoints & docs (default port 8080):**
- Swagger UI: `http://localhost:8080/swagger-ui.html`
- OpenAPI JSON: `http://localhost:8080/api-docs`
- Health: `http://localhost:8080/actuator/health`

If server port is `0` (random), read the actual port from the startup logs.

---

### 3. Database Schema (PostgreSQL)

#### 3.1 `accounts`
Defined in `V1__create_accounts_table.sql`.

```sql
CREATE TABLE IF NOT EXISTS accounts (
    id UUID PRIMARY KEY,
    account_number VARCHAR(32) NOT NULL UNIQUE,
    customer_id UUID NOT NULL,
    account_type VARCHAR(32) NOT NULL,
    status VARCHAR(32) NOT NULL,
    currency CHAR(3) NOT NULL,
    balance NUMERIC(19, 4) NOT NULL,
    opened_at TIMESTAMPTZ NOT NULL,
    updated_at TIMESTAMPTZ NOT NULL
);

CREATE INDEX IF NOT EXISTS idx_accounts_customer_id ON accounts (customer_id);
```

- **Key points**
  - `account_number` is unique and generated by the service.
  - `status` is one of `ACTIVE`, `SUSPENDED`, `CLOSED`.
  - `balance` is maintained in base currency with 4 decimal places.

#### 3.2 `account_transaction_logs` (partitioned)
Defined in `V4__partition_transaction_logs.sql` (not fully shown here).

- Stores **immutable transaction log** entries per account.
- Partitioned by `partition_key` (month) for efficient querying.
- Includes amount, type (`CREDIT`/`DEBIT`), reference idempotency key, and timestamps.

#### 3.3 `account_goals` and `account_goal_contributions`
Defined in `V6__create_account_goals_table.sql` and `V8__add_next_sweep_tracking.sql`.

```sql
CREATE TABLE account_goals (
    id UUID PRIMARY KEY,
    account_id UUID NOT NULL,
    name VARCHAR(128) NOT NULL,
    description TEXT,
    target_amount NUMERIC(19,4) NOT NULL,
    current_amount NUMERIC(19,4) NOT NULL DEFAULT 0,
    due_date DATE,
    status VARCHAR(32) NOT NULL,
    auto_sweep_enabled BOOLEAN NOT NULL DEFAULT FALSE,
    auto_sweep_amount NUMERIC(19,4),
    auto_sweep_cadence VARCHAR(32),
    last_sweep_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ NOT NULL,
    updated_at TIMESTAMPTZ NOT NULL,
    completed_at TIMESTAMPTZ,
    CONSTRAINT fk_account_goals_account FOREIGN KEY (account_id) REFERENCES accounts (id)
);

ALTER TABLE account_goals
    ADD COLUMN IF NOT EXISTS next_sweep_at TIMESTAMPTZ;

CREATE INDEX idx_account_goals_account_id ON account_goals(account_id);
CREATE INDEX idx_account_goals_status ON account_goals(status);
CREATE INDEX idx_account_goals_auto_sweep ON account_goals(auto_sweep_enabled, status);
CREATE INDEX IF NOT EXISTS idx_account_goals_next_sweep
    ON account_goals (next_sweep_at)
    WHERE auto_sweep_enabled = true;

CREATE TABLE account_goal_contributions (
    id UUID PRIMARY KEY,
    goal_id UUID NOT NULL,
    account_id UUID NOT NULL,
    amount NUMERIC(19,4) NOT NULL,
    source VARCHAR(32) NOT NULL,
    description VARCHAR(255),
    reference_id UUID NOT NULL,
    created_at TIMESTAMPTZ NOT NULL,
    CONSTRAINT fk_goal_contributions_goal FOREIGN KEY (goal_id) REFERENCES account_goals(id) ON DELETE CASCADE,
    CONSTRAINT fk_goal_contributions_account FOREIGN KEY (account_id) REFERENCES accounts(id),
    CONSTRAINT uq_goal_contribution_reference UNIQUE (account_id, reference_id)
);
```

- `status` for goals: `ACTIVE`, `COMPLETED`, `CANCELLED` (enum in code).
- `auto_sweep_cadence`: `DAILY`, `WEEKLY`, `MONTHLY`.
- `next_sweep_at` is maintained by the service for batch scheduling.
- `account_goal_contributions.reference_id` ensures idempotent manual contributions per account.

#### 3.4 `event_audit_logs`
Defined in `V7__create_event_audit_logs.sql`.

```sql
CREATE TABLE event_audit_logs (
    id UUID PRIMARY KEY,
    direction VARCHAR(16) NOT NULL,
    status VARCHAR(16) NOT NULL,
    topic VARCHAR(255) NOT NULL,
    event_type VARCHAR(128),
    event_key VARCHAR(255),
    payload TEXT,
    record_partition INTEGER,
    record_offset BIGINT,
    error_message TEXT,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
```

- `direction`: `PUBLISH` or `CONSUME`.
- `status`: `PENDING`, `SUCCESS`, `FAILED`.
- Used for **Kafka event observability** across producers and consumers.

---

### 4. REST APIs with Example Payloads

#### 4.1 Accounts

##### 4.1.1 Create Account
- **POST** `/api/accounts`

**Request JSON**

```json
{
  "customerId": "11111111-1111-1111-1111-111111111111",
  "type": "CHECKING",
  "currency": "USD",
  "initialDeposit": 250.00
}
```

**Response JSON (201)**

```json
{
  "id": "22222222-2222-2222-2222-222222222222",
  "accountNumber": "ACC-00001234",
  "customerId": "11111111-1111-1111-1111-111111111111",
  "type": "CHECKING",
  "status": "ACTIVE",
  "currency": "USD",
  "balance": 250.00,
  "openedAt": "2025-11-26T10:00:00Z",
  "updatedAt": "2025-11-26T10:00:00Z"
}
```

##### 4.1.2 Get Account
- **GET** `/api/accounts/{id}`

```bash
curl -X GET "http://localhost:8080/api/accounts/22222222-2222-2222-2222-222222222222"
```

Returns the same `AccountResponse` structure as above.

##### 4.1.3 List Accounts
- **GET** `/api/accounts?customerId={customerId}&page=0&size=20`

**Response JSON**

```json
{
  "content": [
    {
      "id": "22222222-2222-2222-2222-222222222222",
      "accountNumber": "ACC-00001234",
      "customerId": "11111111-1111-1111-1111-111111111111",
      "type": "CHECKING",
      "status": "ACTIVE",
      "currency": "USD",
      "balance": 250.00,
      "openedAt": "2025-11-26T10:00:00Z",
      "updatedAt": "2025-11-26T10:00:00Z"
    }
  ],
  "page": 0,
  "size": 20,
  "totalElements": 1,
  "totalPages": 1
}
```

##### 4.1.4 Update Account Details
- **PUT** `/api/accounts/{id}`

**Request JSON**

```json
{
  "type": "SAVINGS",
  "currency": "USD"
}
```

##### 4.1.5 Update Account Status
- **PUT** `/api/accounts/{id}/status`

**Request JSON**

```json
{
  "status": "SUSPENDED",
  "reason": "KYC_REVIEW"
}
```

##### 4.1.6 Delete Account
- **DELETE** `/api/accounts/{id}` → 204 No Content

---

#### 4.2 Transactions

##### 4.2.1 Apply Transaction
- **POST** `/api/accounts/{id}/transactions`

**Request JSON**

```json
{
  "type": "DEBIT",
  "amount": 50.00,
  "currency": "USD",
  "referenceId": "33333333-3333-3333-3333-333333333333",
  "description": "ATM withdrawal"
}
```

- `referenceId` is **required and idempotent per account**. Re-sending the same body with same `referenceId` will be treated as a no-op.

**Response JSON (200)**

```json
{
  "id": "22222222-2222-2222-2222-222222222222",
  "accountNumber": "ACC-00001234",
  "customerId": "11111111-1111-1111-1111-111111111111",
  "type": "CHECKING",
  "status": "ACTIVE",
  "currency": "USD",
  "balance": 200.00,
  "openedAt": "2025-11-26T10:00:00Z",
  "updatedAt": "2025-11-26T10:05:00Z"
}
```

##### 4.2.2 Get Balance
- **GET** `/api/accounts/{id}/balance`

**Response JSON**

```json
{
  "accountId": "22222222-2222-2222-2222-222222222222",
  "currency": "USD",
  "availableBalance": 200.00,
  "currentBalance": 200.00,
  "updatedAt": "2025-11-26T10:05:00Z"
}
```

##### 4.2.3 Transaction History
- **GET** `/api/accounts/{id}/transactions?page=0&size=20`

**Response JSON (simplified)**

```json
{
  "content": [
    {
      "id": "44444444-4444-4444-4444-444444444444",
      "type": "DEBIT",
      "amount": 50.00,
      "currency": "USD",
      "referenceId": "33333333-3333-3333-3333-333333333333",
      "createdAt": "2025-11-26T10:05:00Z",
      "description": "ATM withdrawal"
    }
  ],
  "page": 0,
  "size": 20,
  "totalElements": 1,
  "totalPages": 1
}
```

---

#### 4.3 Savings Goals & Auto-Sweep

##### 4.3.1 Create Goal
- **POST** `/api/accounts/{accountId}/goals`

**Request JSON**

```json
{
  "name": "Vacation 2026",
  "description": "Save for summer trip",
  "targetAmount": 2000.00,
  "dueDate": "2026-06-01",
  "autoSweepEnabled": true,
  "autoSweepAmount": 100.00,
  "autoSweepCadence": "MONTHLY"
}
```

**Response JSON (trimmed)**

```json
{
  "id": "55555555-5555-5555-5555-555555555555",
  "accountId": "22222222-2222-2222-2222-222222222222",
  "name": "Vacation 2026",
  "targetAmount": 2000.00,
  "currentAmount": 0.00,
  "status": "ACTIVE",
  "autoSweepEnabled": true,
  "autoSweepAmount": 100.00,
  "autoSweepCadence": "MONTHLY",
  "nextSweepAt": "2025-12-01T00:00:00Z"
}
```

##### 4.3.2 List Goals
- **GET** `/api/accounts/{accountId}/goals?page=0&size=20`

##### 4.3.3 Get / Update Goal
- **GET** `/api/accounts/{accountId}/goals/{goalId}`
- **PUT** `/api/accounts/{accountId}/goals/{goalId}`

**Update Request Example**

```json
{
  "name": "Vacation 2026 (Updated)",
  "description": "Extended trip",
  "targetAmount": 2500.00,
  "autoSweepEnabled": false
}
```

##### 4.3.4 Manual Goal Contribution
- **POST** `/api/accounts/{accountId}/goals/{goalId}/contributions`

**Request JSON**

```json
{
  "amount": 150.00,
  "description": "One-time top-up",
  "referenceId": "66666666-6666-6666-6666-666666666666"
}
```

This debits the account and credits the goal’s `currentAmount`.  
`referenceId` ensures idempotency per account/goal combination.

##### 4.3.5 Auto-Sweep Batch Processing

- Configured under `account.goals.auto-sweep` in `application.yml`:

```yaml
account:
  goals:
    default-cadence: MONTHLY
    auto-sweep:
      enabled: true
      cron: "0 15 1 * * ?"
      min-balance-buffer: 50.00
      default-contribution-amount: 50.00
      min-contribution-amount: 10.00
      max-contribution-amount: 1000.00
      batch-size: 100
      max-batches-per-run: 10
```

- `GoalAutoSweepService`:
  - Runs on the configured cron.
  - Pages through `account_goals` where `auto_sweep_enabled = true`, `status = ACTIVE`, and `next_sweep_at <= now`.
  - Applies contributions up to configured limits and moves `next_sweep_at` forward using `AccountGoalCadence`.

---

### 5. Kafka Integration & Event Schemas

#### 5.1 Topics & Payloads
- **Producer topics** (examples):
  - `accounts.account-created`
  - `accounts.account-updated`

- Payloads conform to `account-event.schema.json`:

```json
{
  "accountId": "22222222-2222-2222-2222-222222222222",
  "accountNumber": "ACC-00001234",
  "customerId": "11111111-1111-1111-1111-111111111111",
  "type": "CHECKING",
  "status": "ACTIVE",
  "currency": "USD",
  "balance": "200.0000",
  "eventType": "ACCOUNT_UPDATED",
  "occurredAt": "2025-11-26T10:05:00Z"
}
```

#### 5.2 Event Monitoring & Metrics
- **AOP Aspect** (`EventMonitoringAspect`):
  - Wraps `KafkaTemplate.send(..)`:
    - Creates `PENDING` row in `event_audit_logs`.
    - On success/failure, updates `status`, `record_partition`, `record_offset`, `error_message`.
  - Wraps `@KafkaListener` methods:
    - On success/failure, inserts a `CONSUME` row (one per consumed message).

- **Metrics** (`EventAuditMetrics`):
  - `events.published{service="account-service",status="success|failure"}`
  - `events.consumed{service="account-service",status="success|failure"}`

---

### 6. Observability & Operational Concerns

- **Micrometer metrics (non-exhaustive)**:
  - `accounts.created`, `accounts.updated`
  - `accounts.transactions.credit`, `accounts.transactions.debit`
  - `accounts.transactions.amount` (distribution, tagged by type)
  - `accounts.balance`
  - `accounts.goals.created`, `accounts.goals.completed`
  - `accounts.goals.contributions{source="MANUAL"|"AUTO"}`
  - HTTP metrics: `http.server.requests`, `http.server.errors`
  - Event metrics as above.

- **Tracing**:
  - Micrometer tracing bridge + Zipkin reporter (`brave`) configured in the parent project.

- **Logging**:
  - Structured JSON logging via Logback + logstash encoder.
  - Request/response logging filter with optional PII masking.

---

### 7. Concurrency, Idempotency, and Error Handling

- **Optimistic locking**:
  - Accounts use a `version` field (`@Version`) to prevent lost updates.
  - Conflicts result in `ConcurrentAccountUpdateException` → HTTP 409.

- **Idempotent operations**:
  - Account transactions and goal contributions require a `referenceId` (UUID).
  - Replays with the same `referenceId` are detected and skipped.
  - Auto-sweep uses deterministic reference keys to avoid duplicates across retries.

- **Validation & error responses**:
  - Jakarta Bean Validation on all request DTOs.
  - Central `GlobalExceptionHandler` maps domain exceptions to structured error responses.

---

### 8. Testing

- **Unit tests**:
  - Service-level tests (`AccountServiceTest`, `AccountGoalServiceTest`, `GoalAutoSweepServiceTest`).
  - Web tests using `@WebMvcTest` (`AccountControllerTest`).
  - Audit tests (`EventAuditServiceTest`, `EventMonitoringAspectTest`).

- **Repository / integration tests**:
  - JPA repositories tested using Testcontainers PostgreSQL to ensure schema compatibility.

**Run all tests**

```bash
cd /Users/tariyalji/gitbot/banking-platform/services/account-service
mvn test
```

