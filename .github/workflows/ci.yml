name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'
          cache: maven
      - name: Build (skip tests)
        run: mvn -B -ntp -pl services/card-service,services/account-service -am package -DskipTests

  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'
          cache: maven
      - name: Run unit tests (card + account)
        env:
          SPRING_PROFILES_ACTIVE: test
        run: mvn -B -ntp -pl services/card-service,services/account-service -am test -DskipITs -Dspring.flyway.enabled=false -Dspring.jpa.hibernate.ddl-auto=create-drop

  sbom:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'
          cache: maven
      - name: Generate aggregate SBOM (CycloneDX)
        run: mvn -B -ntp -DskipTests org.cyclonedx:cyclonedx-maven-plugin:2.7.10:makeAggregateBom
      - uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: target/bom.xml

  dependency-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'
          cache: maven
      - name: OWASP dependency-check
        run: mvn -B -ntp -DskipTests org.owasp:dependency-check-maven:9.0.10:check

  docker:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - name: Build card-service image
        run: docker build -t card-service:ci -f services/card-service/Dockerfile .
      - name: Build account-service image
        run: docker build -t account-service:ci -f services/account-service/Dockerfile .

  helm-lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: azure/setup-helm@v4
        with:
          version: v3.15.2
      - name: Lint card-service chart
        run: helm lint deploy/charts/card-service
      - name: Lint account-service chart
        run: helm lint deploy/charts/account-service

